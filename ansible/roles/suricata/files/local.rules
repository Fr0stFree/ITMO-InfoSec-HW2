# ActiveMQ

# Обнаружение ActiveMQ подключений
alert tcp any any -> any 61616 (msg:"[IDS] Apache ActiveMQ Connection Detected"; flow:to_server,established; threshold:type limit,track by_src,count 1,seconds 300; classtype:policy-violation; sid:3000001; rev:1;)

# Обнаружение OpenWire протокола
alert tcp any any -> any 61616 (msg:"[IDS] Apache ActiveMQ OpenWire Protocol Detected"; flow:to_server,established; content:"OpenWire"; nocase; classtype:policy-violation; sid:3000002; rev:1;)

# Обнаружение Java десериализации (ProcessBuilder)
alert tcp any any -> any 61616 (msg:"[IDS] ActiveMQ Java Deserialization CVE-2023-46604"; flow:to_server,established; content:"ProcessBuilder"; nocase; classtype:attempted-admin; sid:3000003; rev:1;)

# Блокировка подозрительных ActiveMQ запросов
drop tcp any any -> any 61616 (msg:"[IPS] ActiveMQ Exploit Attempt Blocked"; flow:to_server,established; content:"ClassPathXmlApplicationContext"; nocase; threshold:type limit,track by_src,count 1,seconds 60; classtype:attempted-admin; sid:3000004; rev:1;)

# Обнаружение Spring Beans в трафике
alert tcp any any -> any 61616 (msg:"[IDS] ActiveMQ Spring Beans Configuration Detected"; flow:to_server,established; content:"<beans"; nocase; classtype:attempted-admin; sid:3000005; rev:1;)

# Redis

# Обнаружение подключения к Redis (порт 6379)
alert tcp any any -> any 6379 (msg:"[IDS] Redis Unauthorized Access Detected"; flow:to_server,established; threshold:type limit,track by_src,count 1,seconds 300; classtype:policy-violation; sid:3000101; rev:1;)

# Обнаружение команды CONFIG
alert tcp any any -> any 6379 (msg:"[IDS] Redis CONFIG Command Detected"; flow:to_server,established; content:"CONFIG"; nocase; classtype:attempted-admin; sid:3000102; rev:1;)

# Обнаружение команды SAVE
alert tcp any any -> any 6379 (msg:"[IDS] Redis SAVE Command Detected"; flow:to_server,established; content:"SAVE"; nocase; classtype:attempted-admin; sid:3000103; rev:1;)

# Блокировка опасных операций (config set dir ...)
drop tcp any any -> any 6379 (msg:"[IPS] Redis Dangerous Operation Blocked - config set dir"; flow:to_server,established; content:"config set dir"; nocase; threshold:type limit,track by_src,count 1,seconds 60; classtype:attempted-admin; sid:3000104; rev:1;)

# Обнаружение попыток записи веб-шелла (например PHP)
alert tcp any any -> any 6379 (msg:"[IDS] Redis Web Shell Upload Attempt"; flow:to_server,established; content:"<?php"; nocase; classtype:trojan-activity; sid:3000105; rev:1;)

# Обнаружение манипуляций с dbfilename
alert tcp any any -> any 6379 (msg:"[IDS] Redis DBFilename Manipulation"; flow:to_server,established; content:"dbfilename"; nocase; classtype:attempted-admin; sid:3000106; rev:1;)

# Обнаружение команды FLUSHALL
alert tcp any any -> any 6379 (msg:"[IDS] Redis FLUSHALL Command Detected"; flow:to_server,established; content:"FLUSHALL"; nocase; classtype:attempted-admin; sid:3000107; rev:1;)

# Обнаружение большого количества операций (возможный брутфорс/скан)
alert tcp any any -> any 6379 (msg:"[IDS] Redis Multiple Operations Detected"; flow:to_server,established; threshold:type limit,track by_src,count 20,seconds 60; classtype:attempted-recon; sid:3000108; rev:1;)

# MinIO

# Обнаружение CVE-2023-28432 Bootstrap Verify запроса
alert http any any -> any 9000 (msg:"[IDS] MinIO CVE-2023-28432 Bootstrap Verify Request"; flow:to_server,established; http.uri; content:"/minio/bootstrap/v1/verify"; http.method; content:"POST"; classtype:attempted-admin; sid:3000201; rev:1;)

# Блокировка CVE-2023-28432 эксплуатации
drop http any any -> any 9000 (msg:"[IPS] MinIO CVE-2023-28432 Exploitation Blocked"; flow:to_server,established; http.uri; content:"/minio/bootstrap/v1/verify"; http.method; content:"POST"; classtype:attempted-admin; sid:3000202; rev:1;)

# Обнаружение MinIO admin API запросов
alert http any any -> any 9000 (msg:"[IDS] MinIO Admin API Request Detected"; flow:to_server,established; http.uri; content:"/minio/admin"; classtype:attempted-admin; sid:3000203; rev:1;)

# Обнаружение S3 API операций
alert http any any -> any 9000 (msg:"[IDS] MinIO S3 API Operation Detected"; flow:to_server,established; http.header; content:"aws4_request"; classtype:policy-violation; sid:3000204; rev:1;)

# Обнаружение создания bucket'ов
alert http any any -> any 9000 (msg:"[IDS] MinIO Bucket Creation Detected"; flow:to_server,established; http.method; content:"PUT"; classtype:policy-violation; sid:3000205; rev:1;)

# Обнаружение подозрительных имен bucket'ов
alert http any any -> any 9000 (msg:"[IDS] MinIO Suspicious Bucket Name"; flow:to_server,established; http.uri; pcre:"/\/(hack|exploit|malware|backdoor|pwned|compromised|cve)/i"; classtype:trojan-activity; sid:3000206; rev:1;)

# Обнаружение консольного доступа
alert http any any -> any 9001 (msg:"[IDS] MinIO Console Access Detected"; flow:to_server,established; threshold: type limit, track by_src, count 1, seconds 300; classtype:policy-violation; sid:3000207; rev:1;)

# Блокировка множественных S3 операций
drop http any any -> any 9000 (msg:"[IPS] MinIO Excessive S3 Operations Blocked"; flow:to_server,established; threshold: type both, track by_src, count 50, seconds 60; classtype:attempted-dos; sid:3000208; rev:1;)

# SambaCry

# SMB соединения
alert smb any any -> any 445 (msg:"[IDS] SMB Connection Detected"; flow:to_server,established; threshold: type limit, track by_src, count 1, seconds 300; classtype:policy-violation; sid:3000301; rev:1;)

# Загрузка .so через SMB (попытка записи библиотек)
alert smb any any -> any 445 (msg:"[IDS] SMB Shared Library Upload"; flow:to_server,established; file.name; content:".so"; endswith; classtype:trojan-activity; sid:3000302; rev:1;)

# Блокировка известных артефактов SambaCry (имя библиотеки по умолчанию)
drop smb any any -> any 445 (msg:"[IPS] SambaCry Library Upload Blocked"; flow:to_server,established; file.name; content:"libbindshell-samba.so"; endswith; threshold: type limit, track by_src, count 1, seconds 3600; classtype:attempted-admin; sid:3000303; rev:1;)

# Подключение к bind shell на 6699
alert tcp any any -> any 6699 (msg:"[IDS] SambaCry Bind Shell Connection"; flow:to_server,established; threshold: type limit, track by_src, count 1, seconds 60; classtype:trojan-activity; sid:3000304; rev:1;)

# Множественные SMB операции (возможная эксплуатация/брут/скан)
alert smb any any -> any 445 (msg:"[IDS] SMB Multiple File Operations"; flow:to_server,established; threshold: type threshold, track by_src, count 15, seconds 30; classtype:attempted-recon; sid:3000305; rev:1;)

# Операции внутри конкретной шары myshare (триггер при доступе/операциях в шаре)
alert smb any any -> any 445 (msg:"[IDS] SMB Access/Write to myshare"; flow:to_server,established; smb.share; content:"myshare"; endswith; classtype:policy-violation; sid:3000306; rev:1;)

# Jenkins

# Обнаружение доступа к Jenkins
alert http any any -> any 8080 (msg:"[IDS] Jenkins Web Interface Access"; flow:to_server,established; http.uri; content:"/"; threshold: type limit, track by_src, count 1, seconds 300; classtype:policy-violation; sid:3000501; rev:2;)

# Обнаружение загрузки jenkins-cli.jar
alert http any any -> any 8080 (msg:"[IDS] Jenkins CLI JAR Download"; flow:to_server,established; http.uri; content:"jenkins-cli.jar"; nocase; classtype:attempted-recon; sid:3000502; rev:2;)

# Обнаружение Jenkins CLI операций (по User-Agent)
alert http any any -> any 8080 (msg:"[IDS] Jenkins CLI Command Execution"; flow:to_server,established; http.user_agent; content:"Jenkins CLI"; nocase; classtype:attempted-admin; sid:3000503; rev:2;)

# Блокировка CVE-2024-23897 эксплуатации (символ @ в запросах)
drop http any any -> any 8080 (msg:"[IPS] Jenkins CVE-2024-23897 File Read Blocked"; flow:to_server,established; http.request_body; content:"@/"; threshold: type limit, track by_src, count 1, seconds 3600; classtype:attempted-admin; sid:3000504; rev:2;)

# Обнаружение попыток чтения системных файлов
alert http any any -> any 8080 (msg:"[IDS] Jenkins System File Access"; flow:to_server,established; http.request_body; pcre:"/@\/(etc|proc|var)\//"; classtype:attempted-admin; sid:3000505; rev:2;)

# Обнаружение попыток чтения секретов Jenkins
alert http any any -> any 8080 (msg:"[IDS] Jenkins Secret File Access"; flow:to_server,established; http.request_body; content:"@/var/jenkins_home/secret"; nocase; classtype:attempted-admin; sid:3000506; rev:2;)

# Обнаружение множественных Jenkins CLI операций
alert http any any -> any 8080 (msg:"[IDS] Jenkins CLI Multiple Operations"; flow:to_server,established; http.uri; content:"/cli"; threshold: type threshold, track by_src, count 10, seconds 60; classtype:attempted-recon; sid:3000507; rev:2;)

# Обнаружение доступа к JNLP порту (50000)
alert tcp any any -> any 50000 (msg:"[IDS] Jenkins JNLP Port Access"; flow:to_server,established; threshold: type limit, track by_src, count 1, seconds 300; classtype:policy-violation; sid:3000508; rev:2;)

# Обнаружение доступа к debug порту (5005)
alert tcp any any -> any 5005 (msg:"[IDS] Jenkins Debug Port Access"; flow:to_server,established; threshold: type limit, track by_src, count 1, seconds 300; classtype:attempted-admin; sid:3000509; rev:2;)

# Обнаружение HTTP POST к CLI endpoint
alert http any any -> any 8080 (msg:"[IDS] Jenkins CLI HTTP POST"; flow:to_server,established; http.method; content:"POST"; http.uri; content:"/cli"; classtype:attempted-admin; sid:3000510; rev:2;)

# Блокировка агрессивного сканирования Jenkins
drop http any any -> any 8080 (msg:"[IPS] Jenkins Aggressive Scanning Blocked"; flow:to_server,established; threshold: type both, track by_src, count 50, seconds 120; classtype:attempted-dos; sid:3000511; rev:2;)
