# A01:2021 Broken Access Control

# IDOR: прямой доступ к корзине по ID
alert http any any -> $HOME_NET 3000 (msg:"[IDS] IDOR basket access attempt"; flow:to_server,established; http.uri; content:"/rest/basket/"; startswith; classtype:web-application-attack; sid:4501001; rev:1;)

# IDOR: последовательный перебор basket ID (enumeration)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] IDOR basket enumeration detected"; flow:to_server,established; http.uri; content:"/rest/basket/"; startswith; threshold:type both, track by_src, count 3, seconds 10; classtype:web-application-attack; sid:4501002; rev:1;)

# A02:2021 Cryptographic Failures

# Доступ к FTP-директории
alert http any any -> $HOME_NET 3000 (msg:"[IDS] FTP directory access"; flow:to_server,established; http.uri; content:"/ftp/"; classtype:policy-violation; sid:4502001; rev:1;)

# Доступ к backup-файлам (.bak)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Backup file access attempt"; flow:to_server,established; http.uri; pcre:"/\.bak(\?|$|#)/i"; classtype:policy-violation; sid:4502002; rev:1;)

# Poison Null Byte в URI
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Poison Null Byte detected"; flow:to_server,established; http.uri; pcre:"/%00|%2500/i"; classtype:web-application-attack; sid:4502003; rev:1;)

# Доступ к конфиденциальным файлам
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Sensitive file access (coupons)"; flow:to_server,established; http.uri; content:"coupons"; nocase; classtype:policy-violation; sid:4502004; rev:1;)

# A03:2021 Injection

# SQL Injection: OR 1=1 в теле запроса
alert http any any -> $HOME_NET 3000 (msg:"[IDS] SQLi OR 1=1 detected"; flow:to_server,established; http.request_body; pcre:"/or\s+1\s*=\s*1/i"; classtype:web-application-attack; sid:4503001; rev:1;)

# SQL Injection: UNION SELECT в URI
alert http any any -> $HOME_NET 3000 (msg:"[IDS] SQLi UNION SELECT detected"; flow:to_server,established; http.uri; pcre:"/union\s+select/i"; classtype:web-application-attack; sid:4503002; rev:1;)

# SQL Injection: комментарий --
alert http any any -> $HOME_NET 3000 (msg:"[IDS] SQLi comment detected"; flow:to_server,established; http.request_body; content:"--"; classtype:web-application-attack; sid:4503003; rev:1;)

# Блокировка SQLi на endpoint /rest/user/login
drop http any any -> $HOME_NET 3000 (msg:"[IPS] SQLi blocked on login"; flow:to_server,established; http.uri; content:"/rest/user/login"; http.method; content:"POST"; http.request_body; pcre:"/or\s+1\s*=\s*1|union\s+select/i"; sid:4503101; rev:1;)

# A04:2021 Insecure Design

# Массовые попытки логина (5 за 10 сек)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Login brute-force detected"; flow:to_server,established; http.uri; content:"/rest/user/login"; http.method; content:"POST"; threshold:type both, track by_src, count 5, seconds 10; classtype:attempted-recon; sid:4504001; rev:1;)

# Агрессивный brute-force (10+ за 30 сек)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Aggressive login brute-force"; flow:to_server,established; http.uri; content:"/rest/user/login"; http.method; content:"POST"; threshold:type both, track by_src, count 10, seconds 30; classtype:attempted-recon; sid:4504002; rev:1;)

# Блокировка после 5 попыток за 10 секунд
drop http any any -> $HOME_NET 3000 (msg:"[IPS] Login brute-force blocked"; flow:to_server,established; http.uri; content:"/rest/user/login"; http.method; content:"POST"; threshold:type both, track by_src, count 5, seconds 10; sid:4504101; rev:1;)


# A05:2021 Security Misconfiguration

# Poison Null Byte в URI
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Poison Null Byte detected"; flow:to_server,established; http.uri; pcre:"/%00|%2500/i"; classtype:web-application-attack; sid:4505001; rev:1;)

# Доступ к FTP-директории
alert http any any -> $HOME_NET 3000 (msg:"[IDS] FTP directory access"; flow:to_server,established; http.uri; content:"/ftp/"; classtype:policy-violation; sid:4505002; rev:1;)

# Доступ к backup-файлам
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Backup file access"; flow:to_server,established; http.uri; pcre:"/\.bak(\?|$|#)/i"; classtype:policy-violation; sid:4505003; rev:1;)

# Доступ к metrics endpoint
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Metrics endpoint access"; flow:to_server,established; http.uri; content:"/metrics"; classtype:policy-violation; sid:4505004; rev:1;)

# Доступ к Security Questions API
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Security Questions API access"; flow:to_server,established; http.uri; content:"/api/SecurityQuestions"; classtype:policy-violation; sid:4505005; rev:1;)

# Доступ к Score Board
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Score Board access"; flow:to_server,established; http.uri; content:"/score-board"; classtype:policy-violation; sid:4505006; rev:1;)

# A06:2021 Vulnerable Components

# Провоцирование stack trace для fingerprinting
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Error page fingerprinting attempt"; flow:to_server,established; http.uri; pcre:"/\.(txt|exe|dll|jsp|asp|aspx|php|py)$/i"; classtype:attempted-recon; sid:4506001; rev:1;)

# Попытки доступа к конфигам для определения зависимостей
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Dependency config access"; flow:to_server,established; http.uri; pcre:"/(package\.json|composer\.json|requirements\.txt|pom\.xml|build\.gradle)/i"; classtype:attempted-recon; sid:4506003; rev:1;)

# A07:2021 Authentication Failures
# ALREADY IMPLEMENTED IN A03 A04

# A08:2021 Software and Data Integrity Failures

# XSS: тег <script>
alert http any any -> $HOME_NET 3000 (msg:"[IDS] XSS script tag detected"; flow:to_server,established; http.uri; content:"<script"; nocase; classtype:web-application-attack; sid:4508001; rev:1;)

# XSS: onerror/onload event handlers
alert http any any -> $HOME_NET 3000 (msg:"[IDS] XSS event handler detected"; flow:to_server,established; http.uri; pcre:"/on(load|error|click|mouse|key|focus|submit)\\s*=/i"; classtype:web-application-attack; sid:4508002; rev:1;)

# XSS: javascript: URI
alert http any any -> $HOME_NET 3000 (msg:"[IDS] XSS javascript URI detected"; flow:to_server,established; http.uri; content:"javascript:"; nocase; classtype:web-application-attack; sid:4508003; rev:1;)

# XSS: iframe injection
alert http any any -> $HOME_NET 3000 (msg:"[IDS] XSS iframe injection detected"; flow:to_server,established; http.uri; content:"<iframe"; nocase; classtype:web-application-attack; sid:4508004; rev:1;)

# XSS: img tag with onerror
alert http any any -> $HOME_NET 3000 (msg:"[IDS] XSS img onerror detected"; flow:to_server,established; http.uri; content:"<img"; nocase; content:"onerror"; nocase; within:100; classtype:web-application-attack; sid:4508005; rev:1;)
